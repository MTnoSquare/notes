## 项目介绍

该项目是一个类似贴吧的论坛。主要的功能是用户的发帖与评论，在此基础上实现了点赞，关注以及对应的行为产生通知发送到对应用户。同时进行了帖子搜索和热帖排行的功能扩展。以及一些修改头像和密码等基础功能的实现。

## 数据库表设计

### discuss_post

代表主题帖,字段对应信息如下

|  id  | user_id | title | content |   type   |  status  | create_time | comment_count | score |
| :--: | :-----: | :---: | :-----: | :------: | :------: | :---------: | :-----------: | ----- |
| 主键 | 用户 id | 标题  |  内容   | 是否置顶 | 是否加精 |  创建时间   |   评论数量    | 分数  |

**索引**:

user_id 用户查询自己发过的帖子时进行索引查询

### comment

代表评论,字段对应信息如下

|  id  | user_id |           entity_type            | entity_id |   target_id   | content  | status | create_time |
| :--: | :-----: | :------------------------------: | :-------: | :-----------: | :------: | :----: | :---------: |
| 主键 | 用户 id | 实体类型(评论的是主题帖还是评论) |  隶属的主题帖 id,如果为评论的回复,则为评论id  | 若评论的是评论,则为该评论用户的id,否则为0 | 评论内容 |  状态  |  创建时间   |

**索引**:

user_id  :用户查询自己发过的回复时进行索引查询

entity_id :根据主题贴查询其评论时进行索引查询

### user

代表用户,字段对应信息如下
| id | username | password | salt | email | type | status | header_url | activation_code | create_time |
| :--: | :-------: | :------: | :--: | :---: | :------: | :------: | :--------: | --------------- | ----------- |
| 主键 | 用户姓名 | 密码 | 盐值 | 邮箱 | 用户类型 | 是否激活 | 头像 url | 激活码 | 创建时间 |

**索引**:

username   email
### message

代表通知和私信,字段对应信息如下

|  id  |                      from_id                      |                            to_id                            |                                            conversation_id                                             |         content         |  status  | create_time |
| :--: | :-----------------------------------------------: | :---------------------------------------------------------: | :----------------------------------------------------------------------------------------------------: | :---------------------: | :------: | :---------: |
| 主键 | 发送用户 id(对于通知类消息,该值为 1,代表系统通知) | 接收用户的id|代表通信类型(如:like),若为私信,则为 from_id 和 to_id 的拼接 | 内容,(对于通知类消息,该值为{{"entityType":value,"entityId":value,"postId":value,"userId":value}},代表) | 状态,代表未读已读和删除 | 创建时间 |

**索引**:

from_id to_id  :根据to_id进行属于该用户的索引查询

## Redis 在项目中的主要作用

### 缓存

本项目采用 Caffine构建缓存，初始缓存的内容为帖子和热帖前十页的内容。当本地缓存查不到内容时,再查数据库.

由于对缓存一致性要求不高,因此像热帖模块只有计算分数后才会去更新缓存.

Redis采用旁路缓存的模式进行缓存读写.

#### 旁路缓存

先更新数据库,再删除缓存

**单独缓存的局限性**：
* 如果只使用redis来做缓存我们会有大量的请求到redis，但是每次请求的数据都是一样的，假如这一部分数据就放在应用服务器本地，那么就省去了请求redis的网络开销，请求速度就会快很多。但是使用redis横向扩展很方便。
* 如果只使用Caffeine来做本地缓存，我们的应用服务器的内存是有限，并且单独为了缓存去扩展应用服务器是非常不划算。所以，只使用本地缓存也是有很大局限性的。


### 点赞与关注

#### 点赞 set+string

根据帖子的 ID 构建 key，value 为点赞的用户 id，以`set`进行存储。

根据被点赞帖子的用户的 ID 构建 key，value 为被点赞的数量，以`String`进行存储。

对这两个集合一起进行事务操作保证原子性，以`set`中是否存在用户 id 进行是否点赞的判断。

#### 关注 zset

根据当前用户的 id 构建 key，value 为关注用户的 id 构建关注用户的用户 key

根据关注用户的 id 构建 key，value 为当前用户的 id 构建关注用户的用户的 key

同样进行事务操作，zset 以当前时间进行排序，即由新到旧。

### 登录相关

#### cookies

将用户的登录凭证存入cookies,在存入redis

## 注册 登录

### 注册

1. 接受前台传来的用户信息
2. 判断后插入数据库
3. 发送激活邮件,用户点击链接激活
4. 判断激活信息

### 登录

1. 生成验证码并存入`Redis`
2. 接受前台参数，若登录成功构建登录凭证存入`Redis`
3. 使用拦截器，若`cookies`有登录凭证，到`Redis`中查询
4. 匹配则构建用户认证的结果,并存入 SecurityContext,以便于 Security 进行授权。

## 数据统计

#### DAU bitmap

通过拦截器，若用户有登录，进行统计。

通过 OR 运算进行计算

#### UV HyperLogLog

通过 ip 进行计算

Union 取并集，获取 size

## Kafka 的应用
//TODO:

1. 评论，点赞和关注会触发通知事件，对内容进行封装插入数据库。

2. 发帖和删帖事件异步进行 es 内容的增删查改。

## 帖子分数更新

对于分数更新的操作，不会立马写入 Mysql 和 ES。在 Redis 中维护一个集合`set`，存储需要更新分数的帖子 id，对于每个影响帖子分数的操作，将其帖子 id 存入。

定时任务设定为每十分钟更新一次分数，从 Redis 维护的集合中依次取出 id，更新 Mysql 和 ES 中的帖子分数

## 发帖与回帖

帖子类型分为主题帖和评论两类. 根据主题帖,查询其对应的评论和点赞等信息,对于评论可能还有评论,同样进行判断.

## 优化

### 1.频繁发帖

将用户存入redis,设置过期时间.当发帖时检测redis中用户key是否过期

### 2.
