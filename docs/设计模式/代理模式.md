# ä»£ç†æ¨¡å¼
## æ¦‚å¿µ
åœ¨ä¸æ”¹å˜åŸå§‹ç±»ï¼ˆæˆ–å«è¢«ä»£ç†ç±»ï¼‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼•å…¥ä»£ç†ç±»æ¥ç»™åŸå§‹ç±»é™„åŠ åŠŸèƒ½ã€‚

## åº”ç”¨åœºæ™¯
1. ä¸šåŠ¡ç³»ç»Ÿçš„éåŠŸèƒ½æ€§éœ€æ±‚å¼€å‘
   
   ä¾‹å¦‚ï¼šç›‘æ§ï¼Œç»Ÿè®¡ï¼Œæ—¥å¿—ï¼Œé™æµï¼Œäº‹åŠ¡ç­‰ï¼Œå°†è¿™äº›åŠŸèƒ½ä¸ä¸šåŠ¡åŠŸèƒ½è§£è€¦ï¼Œåœ¨ä»£ç†ç±»ä¸­ç»Ÿä¸€å¤„ç†ã€‚

2. åº”ç”¨äºRPC
   
   å°†ç½‘ç»œé€šä¿¡ï¼Œæ•°æ®è§£è€¦ç ç­‰ç»†èŠ‚éšè—ï¼Œä½¿å®¢æˆ·ç«¯ä½¿ç”¨RPCæœåŠ¡æ—¶å°±åƒä½¿ç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ï¼Œæ— éœ€äº†è§£è·ŸæœåŠ¡å™¨äº¤äº’ç»†èŠ‚ã€‚

3. ç¼“å­˜
   
   åœ¨ä»£ç†ç±»ä¸­æ‹¦æˆªè¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚å¸¦æœ‰æ”¯æŒç¼“å­˜çš„å­—æ®µï¼Œä»ç¼“å­˜ä¸­è·å–æ•°æ®ç›´æ¥è¿”å›ã€‚

## Javaä¸­çš„ä»£ç†
Javaä¸­çš„ä»£ç†æŒ‰ç…§ä»£ç†ç±»ç”Ÿæˆæ—¶æœºä¸åŒåˆåˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ã€‚é™æ€ä»£ç†ä»£ç†ç±»åœ¨ç¼–è¯‘æœŸå°±ç”Ÿæˆï¼Œè€ŒåŠ¨æ€ä»£ç†ä»£ç†ç±»åˆ™æ˜¯åœ¨Javaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€‚åŠ¨æ€ä»£ç†åˆæœ‰JDKä»£ç†å’ŒCGLibä»£ç†ä¸¤ç§

### JDKä»£ç†


åœ¨javaçš„java.lang.reflectåŒ…ä¸‹æä¾›äº†ä¸€ä¸ªProxyç±»å’Œä¸€ä¸ªInvocationHandleræ¥å£ï¼Œé€šè¿‡è¿™ä¸ªç±»å’Œè¿™ä¸ªæ¥å£å¯ä»¥ç”ŸæˆJDKåŠ¨æ€ä»£ç†ç±»å’ŒåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚

è¿™é‡Œä»¥RPC clientä¸ºğŸŒ°ï¼Œå®¢æˆ·ç«¯é€šè¿‡`RpcClientProxy`è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒåªéœ€è¦çŸ¥é“æ–¹æ³•çš„å‚æ•°ï¼Œå¯¹äºç½‘ç»œä¼ è¾“ç­‰ç»†èŠ‚ï¼Œç”±ä»£ç†ç±»`RpcClientProxy`è¿›è¡Œå®ç°ã€‚


```java
public class RpcClientProxy implements InvocationHandler {

    private static final Logger logger = LoggerFactory.getLogger(RpcClientProxy.class);

    private final RpcClient client;

    public RpcClientProxy(RpcClient client) {
        this.client = client;
    }

    public <T> T getProxy(Class<T> clazz){
        //åˆ›å»ºä»£ç†å¯¹è±¡
        /*
         newProxyInstance()æ–¹æ³•å‚æ•°è¯´æ˜ï¼š
            ClassLoader loaderï¼šç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†ç±»ï¼Œä½¿ç”¨çœŸå®å¯¹è±¡çš„ç±»åŠ è½½å™¨å³å¯
            Class<?>[] interfaces:çœŸå®å¯¹è±¡æ‰€å®ç°çš„æ¥å£ï¼Œä»£ç†æ¨¡å¼çœŸå®å¯¹è±¡å’Œä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£
            InvocationHandler hï¼šä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åº
        */
        return (T) Proxy.newProxyInstance(clazz.getClassLoader(), new Class<?>[]{clazz}, this);
    }
         /*
            InvocationHandlerä¸­invokeæ–¹æ³•å‚æ•°è¯´æ˜ï¼š
               proxyï¼šä»£ç†å¯¹è±¡
               methodï¼šå¯¹åº”äºåœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨çš„æ¥å£æ–¹æ³•çš„Methodå®ä¾‹
               argsï¼šä»£ç†å¯¹è±¡è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä¼ é€’çš„å®é™…å‚æ•°
         */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) {
        logger.info("è°ƒç”¨æ–¹æ³•ï¼š{}#{}", method.getDeclaringClass().getName(), method.getName());
        //å°†è°ƒç”¨æ–¹æ³•çš„å‚æ•°ä¿¡æ¯å°è£…
        RpcRequest rpcRequest = new RpcRequest(UUID.randomUUID().toString(), method.getDeclaringClass().getName(),
                method.getName(), args, method.getParameterTypes(), false);
         //è¿™é‡Œåªæ˜¯ä¸¾ä¾‹å­ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä»£ç†ç±»åšçš„äº‹å°±æ˜¯å‘èµ·è¿œç¨‹è°ƒç”¨å¹¶è¿”å›ç»“æœ
         RpcResponse rpcResponse = (RpcResponse) client.sendRequest(rpcRequest);

         return rpcResponse.getData();
        
    }
}
```

```java
         interface DemoInterface {
            String hello(String msg);
         }

         class DemoImpl implements DemoInterface {
            @Override
            public String hello(String msg) {
               System.out.println("msg = " + msg);
               return "hello";
            }
         }

         class DemoProxy implements InvocationHandler {

            private DemoInterface service;

            public DemoProxy(DemoInterface service) {
               this.service = service;
            }

            @Override
            /*
               proxyï¼šä»£ç†å¯¹è±¡
               methodï¼šå¯¹åº”äºåœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨çš„æ¥å£æ–¹æ³•çš„Methodå®ä¾‹
               argsï¼šä»£ç†å¯¹è±¡è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä¼ é€’çš„å®é™…å‚æ•°
            */
            public Object invoke(Object obj, Method method, Object[] args) throws Throwable {
               System.out.println("è°ƒç”¨æ–¹æ³•å‰...");
               Object returnValue = method.invoke(service, args);
               System.out.println("è°ƒç”¨æ–¹æ³•å...");
               return returnValue;
            }

         }

         public class Solution {
            public static void main(String[] args) {
               DemoProxy proxy = new DemoProxy(new DemoImpl());
               DemoInterface service = Proxy.newInstance(DemoInterface.class.getClassLoader(),new Class<?>[]{DemoInterface.class},proxy);
               System.out.println(service.hello("å‘€å“ˆå–½ï¼"));
            }
         }
```
### CGLibä»£ç†

CGLib**åº•å±‚é‡‡ç”¨ASMå­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œä½¿ç”¨å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä»£ç†ç±»**ï¼Œåœ¨JDK1.6ä¹‹å‰æ¯”ä½¿ç”¨Javaåå°„æ•ˆç‡è¦é«˜ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**CGLibä¸èƒ½å¯¹å£°æ˜ä¸ºfinalçš„ç±»æˆ–è€…æ–¹æ³•è¿›è¡Œä»£ç†ï¼Œå› ä¸ºCGLibåŸç†æ˜¯åŠ¨æ€ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»ã€‚**

åœ¨JDK1.6ã€JDK1.7ã€JDK1.8é€æ­¥å¯¹JDKåŠ¨æ€ä»£ç†ä¼˜åŒ–ä¹‹åï¼Œåœ¨è°ƒç”¨æ¬¡æ•°è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ŒJDKä»£ç†æ•ˆç‡é«˜äºCGLibä»£ç†æ•ˆç‡ï¼Œåªæœ‰å½“è¿›è¡Œå¤§é‡è°ƒç”¨çš„æ—¶å€™ï¼ŒJDK1.6å’ŒJDK1.7æ¯”CGLibä»£ç†æ•ˆç‡ä½ä¸€ç‚¹ï¼Œä½†æ˜¯åˆ°JDK1.8çš„æ—¶å€™ï¼ŒJDKä»£ç†æ•ˆç‡é«˜äºCGLibä»£ç†ã€‚æ‰€ä»¥å¦‚æœ**æœ‰æ¥å£ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ä½¿ç”¨CGLIBä»£ç†ã€‚**

**ä½¿ç”¨**

1. å®šä¹‰ä¸€ä¸ªç±»ï¼›
2. è‡ªå®šä¹‰ `MethodInterceptor` å¹¶é‡å†™ `intercept` æ–¹æ³•ï¼Œ`intercept `ç”¨äºæ‹¦æˆªå¢å¼ºè¢«ä»£ç†ç±»çš„æ–¹æ³•ï¼Œå’Œ JDK åŠ¨æ€ä»£ç†ä¸­çš„ `invoke` æ–¹æ³•ç±»ä¼¼ï¼›
3. é€šè¿‡ `Enhancer` ç±»çš„ `create()`åˆ›å»ºä»£ç†ç±»ï¼›

```java
public class CglibProxyFactory{
   public static Object getProxy(Class<?> clazz){
      //åˆ›å»ºåŠ¨æ€ä»£ç†å¢å¼ºç±»
      Enhancer enhancer=new Enhancer();
      //è®¾ç½®ç±»åŠ è½½å™¨
      enhancer.setClassLoader(clazz.getClassLoader());
      //è®¾ç½®è¢«ä»£ç†ç±»
      enhancer.setSuperclass(clazz);
      //è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨
      enhancer.setCallback(new DebugMethodInterceptor());
      //åˆ›å»ºä»£ç†ç±»
      return enhancer.create();
   }
}
```

```java
public class DebugMethodInterceptor implements MethodInterceptor{
   /*
      oï¼š   ä»£ç†å¯¹è±¡
      methodï¼š è¢«æ‹¦æˆªçš„æ–¹æ³•
      argsï¼š   æ–¹æ³•å…¥å‚
      methodProxyï¼š è°ƒç”¨åŸå§‹æ–¹æ³•

   */
   @Override
   public Object intercept(Object o,Method method,Object[]args,MethodProxy methodProxy){
      //è°ƒç”¨çš„æ–¹æ³•
      Object object=methodProxy.invokeSuper(o,args);

      return Object;
   }
}
```